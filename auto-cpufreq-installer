#!/usr/bin/env bash

# auto-cpufreq-installer:
# auto-cpufreq Rust-based source code installer

cd "$(dirname "$(readlink -f "$0")")"/auto-cpufreq || exit 1

COLUMNS="`tput cols`"
MID="$((COLUMNS / 2))"

APPLICATIONS_PATH="/usr/share/applications"
SHARE_DIR="/usr/local/share/auto-cpufreq/"
BIN_DIR="/usr/local/bin"

AUTO_CPUFREQ_FILE="$BIN_DIR/auto-cpufreq"
AUTO_CPUFREQ_GTK_FILE="$BIN_DIR/auto-cpufreq-gtk"
AUTO_CPUFREQ_TRAY_FILE="$BIN_DIR/auto-cpufreq-tray"
AUTO_CPUFREQ_GTK_DESKTOP_FILE="auto-cpufreq-gtk.desktop"

IMG_FILE="/usr/share/pixmaps/auto-cpufreq.png"
ORG_FILE="/usr/share/polkit-1/actions/org.auto-cpufreq.pkexec.policy"

SYSTEMD_SERVICE_FILE="/etc/systemd/system/auto-cpufreq.service"

function header {
  echo
  printf "%0.s─" $(seq $((MID-(${#1}/2)-2)))
  printf " $1 "
  printf "%0.s─" $(seq $((MID-(${#1}/2)-2)))
  echo; echo
}

function ask_operation {
  header "auto-cpufreq installer"
  echo "Welcome to auto-cpufreq Rust tool installer."; echo
  read -p "Select a key [I]nstall/[R]emove or press ctrl+c to quit: " answer
}

function manual_install {
  if command -v lsb_release > /dev/null; then
    distro="$(lsb_release -is)"
    release="$(lsb_release -rs)"
    codename="$(lsb_release -cs)"
  fi

  echo "Didn't detect Debian or RedHat or Arch based distro."; echo
  echo "To complete installation, you need to:"
  echo "Install: rust, cargo, gcc, pkg-config, gtk4 development libraries"; echo
  echo "For GUI support, also install: libgtk-4-dev"; echo
  echo "Run following sequence of lines:"; echo
  echo "-----"; echo
  echo "cargo build --release"
  echo "sudo cp target/release/auto-cpufreq $BIN_DIR/"
  echo "sudo mkdir -p $SHARE_DIR"
  echo "sudo cp -r ../scripts/ $SHARE_DIR"
  echo "sudo cp -r ../images/ $SHARE_DIR"; echo
  echo "-----"; echo
  echo "After which tool is installed, for full list of options run:";echo
  echo "auto-cpufreq --help"

  echo; printf "%0.s─" $(seq $COLUMNS); echo
  
  echo "Consider creating a feature request to add support for your distro:"
  echo "https://github.com/AdnanHodzic/auto-cpufreq/issues/new"; echo
  echo "Make sure to include following information:"; echo
  echo "Distribution: $distro"
  echo "Release: $release"
  echo "Codename: $codename"
  echo

  exit 1
}

function check_rust {
  if ! command -v rustc &> /dev/null; then
    echo "Rust is not installed. Installing Rust..."
    curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y
    source "$HOME/.cargo/env"
  else
    echo "Rust is already installed: $(rustc --version)"
  fi
}
function tool_install {
  echo
  
  # --- 1. AŞAM: DESTEKLEYİCİ DOSYALARI VE SCRIPTS DİZİNİNİ EN BAŞTA KOPYALA ---
  header "Pre-installing supporting files and scripts"
  
  # Klasörleri oluştur
  mkdir -p $SHARE_DIR
  
  # Scripts ve Images dizinlerini kopyala
  if [ -d "../scripts" ]; then
    cp -r ../scripts/ $SHARE_DIR
    echo "Scripts directory copied to $SHARE_DIR"
  fi
  
  if [ -d "../images" ]; then
    cp -r ../images/ $SHARE_DIR
    echo "Images directory copied to $SHARE_DIR"
  fi

  # Policy ve Icon dosyalarını erkenden yerleştir
  if [ -f ../images/icon.png ]; then
    cp ../images/icon.png $IMG_FILE
  fi
  
  if [ -f ../scripts/org.auto-cpufreq.pkexec.policy ]; then
    cp ../scripts/org.auto-cpufreq.pkexec.policy $ORG_FILE
    echo "Policy file installed to $ORG_FILE"
  fi

  # cpufreqctl scriptini erkenden kur
  if [ -f ../scripts/cpufreqctl.sh ]; then
    cp ../scripts/cpufreqctl.sh /usr/local/bin/cpufreqctl.auto-cpufreq
    chmod 755 /usr/local/bin/cpufreqctl.auto-cpufreq
  fi

  # --- 2. AŞAM: DAĞITIM TESPİTİ VE BAĞIMLILIKLAR ---
  function detected_distro {
    header "Detected $1 distribution"
    header "Setting up Rust build environment"
  }

  if [ -f /etc/debian_version ]; then  
    detected_distro "Debian based"
    apt update
    apt install -y curl gcc pkg-config libssl-dev dmidecode
    if apt-cache show libgtk-4-dev > /dev/null 2>&1; then
      apt install -y libgtk-4-dev 
    else
      apt install -y libgtk-3-dev
    fi
  elif [ -f /etc/redhat-release ]; then
    detected_distro "RedHat based"
    yum install -y curl gcc openssl-devel dmidecode pkgconfig
    yum list gtk4-devel &> /dev/null && yum install -y gtk4-devel || yum install -y gtk3-devel 
  elif [ -f /etc/arch-release ]; then
    detected_distro "Arch Linux based"
    pacman -S --noconfirm --needed curl gcc openssl dmidecode pkg-config
    pacman -Ss gtk4 &> /dev/null && pacman -S --noconfirm --needed gtk4 || pacman -S --noconfirm --needed gtk3 
  # ... (Diğer OS kontrolleri aynı kalacak)
  elif [ -f /etc/os-release ]; then
     . /etc/os-release
     case $ID in
       void)
         detected_distro "Void Linux"
         xbps-install -Sy curl gcc openssl-devel dmidecode pkg-config
         xbps-query gtk4-devel &> /dev/null && xbps-install -Sy gtk4-devel || xbps-install -Sy gtk+3-devel 
       ;;
       # ... nixos vb. case yapıları buraya
     esac
  fi

  # --- 3. AŞAM: RUST VE DERLEME (BUILD) ---
  header "Installing Rust toolchain"
  check_rust

  header "Building auto-cpufreq from source"
  git config --global --add safe.directory $(pwd)
  
  cargo build --release
  if [ $? -ne 0 ]; then
    echo "Build failed! Binary could not be installed, but scripts are at $SHARE_DIR"
    exit 1
  fi

  # GUI build denemesi
  if cargo build --release --features gui 2>/dev/null; then
    echo "GUI support successfully built"
    HAS_GUI=true
  else
    HAS_GUI=false
  fi

  # --- 4. AŞAM: BINARY DOSYALARININ KOPYALANMASI ---
  header "Installing auto-cpufreq binaries"

  cp target/release/auto-cpufreq $AUTO_CPUFREQ_FILE
  chmod 755 $AUTO_CPUFREQ_FILE

  if [ "$HAS_GUI" = true ]; then
    [ -f target/release/auto-cpufreq-gtk ] && cp target/release/auto-cpufreq-gtk $AUTO_CPUFREQ_GTK_FILE && chmod 755 $AUTO_CPUFREQ_GTK_FILE
    [ -f target/release/auto-cpufreq-tray ] && cp target/release/auto-cpufreq-tray $AUTO_CPUFREQ_TRAY_FILE && chmod 755 $AUTO_CPUFREQ_TRAY_FILE
    
    # Desktop file kurulumu
    if [ -f ../scripts/$AUTO_CPUFREQ_GTK_DESKTOP_FILE ]; then
      desktop-file-install --dir=$APPLICATIONS_PATH ../scripts/$AUTO_CPUFREQ_GTK_DESKTOP_FILE
      update-desktop-database $APPLICATIONS_PATH 2>/dev/null || true
    fi
  fi
  
  header "auto-cpufreq tool successfully installed"
  echo "Scripts & Binaries are now in place."
  echo "To install as a daemon service, run: sudo auto-cpufreq --install"
}

function tool_remove {
  # stop any running auto-cpufreq argument (daemon/live/monitor)
  tool_arg_pids=($(pgrep -f "auto-cpufreq --"))
  for pid in "${tool_arg_pids[@]}"; do 
    [ $pid != $$ ] && kill "$pid" 2>/dev/null
  done

  function remove_directory {
    [ -d $1 ] && rm -rf $1
  }
  
  function remove_file {
    [ -f $1 ] && rm $1
  }

  # run uninstall in case of installed daemon
  if [ -f $AUTO_CPUFREQ_FILE ]; then
    echo "Removing daemon service..."
    $AUTO_CPUFREQ_FILE --remove 2>/dev/null || true
  else
    echo "auto-cpufreq binary not found at $AUTO_CPUFREQ_FILE"
  fi

  header "Removing auto-cpufreq"

  # remove auto-cpufreq and all its supporting files
  remove_directory $SHARE_DIR

  remove_file $AUTO_CPUFREQ_FILE
  remove_file $AUTO_CPUFREQ_GTK_FILE
  remove_file $AUTO_CPUFREQ_TRAY_FILE
  remove_file $IMG_FILE
  remove_file $ORG_FILE
  remove_file "/usr/local/bin/cpufreqctl.auto-cpufreq"
  remove_file "/var/run/auto-cpufreq.stats"
  remove_file "/opt/auto-cpufreq/override.pickle"
  remove_file "/opt/auto-cpufreq/turbo-override.pickle"

  remove_file "$APPLICATIONS_PATH/$AUTO_CPUFREQ_GTK_DESKTOP_FILE"
  update-desktop-database $APPLICATIONS_PATH 2>/dev/null || true

  # Remove systemd service if exists
  if [ -f $SYSTEMD_SERVICE_FILE ]; then
    systemctl stop auto-cpufreq 2>/dev/null || true
    systemctl disable auto-cpufreq 2>/dev/null || true
    remove_file $SYSTEMD_SERVICE_FILE
    systemctl daemon-reload
  fi

  # Don't remove Rust installation as it might be used by other tools
  
  echo
  echo "auto-cpufreq tool and all its supporting files successfully removed"
  echo
}

# root check
if ((EUID != 0)); then
  echo
  echo "Must be run as root (i.e: 'sudo $0')."
  echo
  exit 1
fi

if [[ -z "$1" ]]; then 
  ask_operation
else
  case "$1" in
    --install) answer="i";;
    --remove) answer="r";;
    *) ask_operation;;
  esac
fi

case $answer in
  I|i) tool_install;;
  R|r) tool_remove;;
  *)
    echo "Unknown key, aborting ..."
    echo
    exit 1
  ;;
esac
